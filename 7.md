<h1>优先使用异常处理错误</h1>

<h2>理由</h2>
不应该让错误可以被忽略，因为这将导致系统或者一次运算进入未定义的（或者预料之外的）状态。 这是错误的一个主要来源。异常有以下优点：

1. 异常会强制调用代码识别并处理错误状态。 未经处理的异常会停止程序执行
2. 异常跳转到调用堆栈中可以处理错误的位置。中间函数可以让异常传播。这些函数不必与其他层协调
3. 引发异常后，异常堆栈展开机制将根据妥善定义的规则销毁范围内的所有对象
4. 异常可以在检测错误的代码与处理错误的代码之间实现明确的分离
5. 异常是处理构造函数失败的唯一途径

<h2>说明</h2>
异常是一个稍有争议的话题，主要是较为权威的谷歌C++规范明确说明其不允许使用异常，而微软的规范、Bjarne Stroustrup的C++核心编程指南是明确推荐使用异常处理错误。笔者在实际的项目开发中，观察到使用异常的代码也并不多。但是，我认为使用异常利大于弊并推荐你使用，尤其是在新项目中。下面是谷歌C++规范给出的不使用异常的理由：

1. 在现有函数中添加 `throw` 语句时，您必须检查所有调用点
2. 异常会彻底扰乱程序的执行流程并难以判断，函数也许会在您意料不到的地方返回
3. 异常安全需要RAII和不同的编码实践
4. 滥用异常会变相鼓励开发者去捕捉不合时宜

谷歌C++规范中反对异常的理由，在我看来并不是异常的劣势，其仅仅是使用异常的注意事项。就像所有新特性都会有的注意事项一样，只不过异常的使用注意事项复杂了一点，但这并不是不使用异常的理由。

<h2>讨论</h2>

<h3>错误是什么</h3>

错误的含义是函数无法达成其所宣称的目标（这包括后条件的建立）。把错误忽略掉的调用方代码将导致错误的结果，或者未定义的系统状态。 例如，无法连接一个远程服务器本身并不是错误： 这个服务器可以因为各种原因而拒绝连接，因此合乎常理的方式是让其返回一个其调用者必然要检查的结果。 不过，如果无法连接本身就是被当作一种错误的话，这个失败时应当抛出一个异常。

<h3>如果未引发异常，则异常机制的性能开销极低</h3>

如果引发异常，则堆栈遍历和展开的开销与函数调用的开销大致相当。 进入 try 块后，需要使用其他数据结构来跟踪调用堆栈，如果引发异常，则还需要使用更多指令来展开堆栈。 但是，在大多数情况下，性能和内存占用的开销并不高。 异常对性能的不利影响可能仅在内存受限的系统上才比较明显。 或者，这种影响在性能关键型循环中（其中的错误可能经常发生，并且处理错误的代码与报告错误的代码之间存在紧密耦合）可能比较明显。

无论在哪种情况下，不进行分析和测量就不可能知道异常的实际开销。 即使在开销很高的极少数情况下，也可将这种开销与设计良好的异常策略所提供的更高正确性、更方便的维护性和其他优势进行权衡。

1. 通常，显式的错误检查和处理会消耗掉和异常处理一样多的时间和空间。
2. 通常，使用异常的更清晰的代码会带来更好的性能（简化了对程序执行路径的追踪和其优化）。
3. 一条对性能关键代码的好规则是，把检查从代码的关键部分中移出去。
4. 长期来看，更规整的代码会得到更好的优化。
5. 在做出性能相关的声明前一定要小心地进行测量。

<h3>判断异常或错误码使用过度</h3>

错误码使用过度的一个标志就是，应用程序需要不断地检查各种琐细的为真条件，或者(更糟糕地)不检查应该检查的错误码。

异常使用过度的一个标志就是，应用程序代码频繁地抛出和捕获异常，以致于try代码块成功与失败的次数是同一数量级的。这样的catch代码块要么没有处理真正的错误(违反了前条件、后条件和不变式的错误)，要么说明程序存在严重问题。